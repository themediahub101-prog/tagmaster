<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>TagMaster v8.0</title>
    
    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23F97316'/><path d='M30 35h40M30 55h40M30 75h25' stroke='white' stroke-width='8' stroke-linecap='round'/></svg>">
    <script>
        (function() {
            try {
                var c = document.createElement('canvas'); c.width=180; c.height=180; var x = c.getContext('2d');
                x.fillStyle='#F97316'; x.fillRect(0,0,180,180);
                x.strokeStyle='#FFFFFF'; x.lineWidth=14; x.lineCap='round';
                x.beginPath(); x.moveTo(50,60); x.lineTo(130,60); x.stroke();
                x.beginPath(); x.moveTo(50,90); x.lineTo(130,90); x.stroke();
                x.beginPath(); x.moveTo(50,120); x.lineTo(90,120); x.stroke();
                var l = document.createElement('link'); l.rel='apple-touch-icon'; l.href=c.toDataURL('image/png'); document.head.appendChild(l);
            } catch(e){}
        })();
    </script>

    <!-- LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        notion: { bg: '#FFFFFF', sidebar: '#F7F7F5', hover: '#EFEFEF', text: '#37352F', dim: '#9B9A97', border: '#E9E9E7', blue: '#2383E2', red: '#E03E3E', yellow: '#FAEB8F' }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        body { -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }
        [contenteditable]:focus { outline: none; }
        
        .modal-editor { min-height: 300px; max-height: 60vh; overflow-y: auto; line-height: 1.7; font-size: 1.05rem; }
        .modal-editor:empty:before { content: attr(data-placeholder); color: #9B9A97; pointer-events: none; display: block; }
        .modal-editor ul { list-style-type: disc; margin-left: 1.5em; }
        .modal-editor ol { list-style-type: decimal; margin-left: 1.5em; }
        .modal-editor h1 { font-size: 1.8em; font-weight: 700; margin-top: 0.8em; margin-bottom: 0.4em; }
        .modal-editor h2 { font-size: 1.4em; font-weight: 600; margin-top: 0.6em; margin-bottom: 0.2em; }
        .modal-editor blockquote { border-left: 4px solid #E0E0E0; padding-left: 1em; color: #666; font-style: italic; margin: 0.5em 0; }
        .modal-editor span[style*="background-color"] { border-radius: 4px; padding: 0 2px; }
        
        .modal-editor input[type="checkbox"] {
            appearance: none; -webkit-appearance: none;
            width: 1.1em; height: 1.1em;
            border: 1.5px solid #37352F; border-radius: 3px;
            display: inline-block; vertical-align: middle; margin-right: 0.5em;
            position: relative; cursor: pointer; top: -1px;
        }
        .modal-editor input[type="checkbox"]:checked { background-color: #2383E2; border-color: #2383E2; }
        .modal-editor input[type="checkbox"]:checked::after {
            content: ''; position: absolute; left: 0.35em; top: 0.1em; width: 0.3em; height: 0.6em;
            border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg);
        }

        .preview-text { display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; word-break: break-word; white-space: pre-wrap; color: #4a4a4a; font-size: 0.875rem; line-height: 1.5; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        input[type="date"], input[type="time"], input[type="datetime-local"] {
            -webkit-appearance: none; appearance: none;
            color: #37352F !important; -webkit-text-fill-color: #37352F !important;
            opacity: 1 !important; background-color: white; min-height: 36px; padding-top: 6px; padding-bottom: 6px;
        }
    </style>
</head>
<body class="bg-notion-bg text-notion-text h-screen overflow-hidden flex">

    <div id="app" class="flex w-full h-full">
        <!-- SIDEBAR -->
        <aside class="fixed inset-y-0 left-0 bg-notion-sidebar border-r border-notion-border flex flex-col transition-all duration-300 z-30 transform md:relative md:translate-x-0"
               :class="{'translate-x-0 w-64 shadow-xl md:shadow-none': sidebarOpen, '-translate-x-full w-64': !sidebarOpen}">
            <div class="p-4 flex items-center justify-between font-bold select-none text-notion-text">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 bg-orange-500 text-white flex items-center justify-center rounded text-xs"><i class="ph-bold ph-note text-sm"></i></div>
                    <span>TagMaster v8.0</span>
                </div>
                <button @click="sidebarOpen = false" class="md:hidden text-notion-dim p-1"><i class="ph ph-caret-left"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto px-2 py-2">
                <div class="text-xs font-semibold text-notion-dim uppercase tracking-wider px-2 mb-2 mt-2">Library</div>
                <div @click="setFilter(null)" class="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm cursor-pointer transition-colors mb-4" :class="activeTag === null ? 'bg-gray-200 font-medium' : 'hover:bg-notion-hover'"><i class="ph ph-list text-lg"></i> All Items</div>
                <div class="text-xs font-semibold text-notion-dim uppercase tracking-wider px-2 mb-2 flex justify-between items-center"><span>Hashtags</span><i class="ph ph-arrows-down-up text-xs" title="Drag to reorder"></i></div>
                <div ref="tagListRef" class="space-y-0.5">
                    <div v-for="tag in sortedTags" :key="tag" :data-id="tag" @click="setFilter(tag)" class="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm cursor-pointer group transition-colors select-none" :class="activeTag === tag ? 'bg-blue-100 text-blue-700 font-medium' : 'hover:bg-notion-hover'"><i class="ph ph-hash text-notion-dim group-hover:text-blue-500 cursor-grab active:cursor-grabbing"></i><span class="flex-1">{{ tag }}</span></div>
                </div>
                <div v-if="sortedTags.length === 0" class="px-3 text-xs text-notion-dim italic mt-2">Tags appear here.</div>
            </div>
            <div class="p-3 border-t border-gray-200 bg-gray-50/50">
                <div class="flex items-center gap-1.5 text-[10px] text-gray-400 mb-2 px-1"><i class="ph-bold ph-hard-drives"></i> Local Storage</div>
                <div class="flex gap-2">
                    <button @click="exportData" class="flex-1 flex items-center justify-center gap-1 bg-white border border-gray-200 rounded py-1.5 text-xs text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors shadow-sm"><i class="ph ph-download-simple"></i> Export</button>
                    <button @click="$refs.fileInput.click()" class="flex-1 flex items-center justify-center gap-1 bg-white border border-gray-200 rounded py-1.5 text-xs text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors shadow-sm"><i class="ph ph-upload-simple"></i> Import</button>
                    <input ref="fileInput" type="file" class="hidden" accept=".json" @change="importData">
                </div>
            </div>
        </aside>
        <div v-if="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 bg-black/20 z-20 md:hidden"></div>

        <!-- MAIN -->
        <main class="flex-1 flex flex-col h-full overflow-hidden bg-white relative w-full">
            <button @click="sidebarOpen = !sidebarOpen" class="absolute top-4 left-4 z-10 text-notion-dim hover:text-notion-text p-1 rounded hover:bg-notion-hover md:hidden"><i class="ph ph-list text-xl"></i></button>
            <div class="flex-1 overflow-y-auto w-full h-full scroll-smooth">
                <div class="w-full max-w-7xl mx-auto px-4 md:px-12 py-6 md:py-12">
                    <header class="mb-8 mt-2 pl-8 md:pl-0 flex flex-col md:flex-row md:items-end justify-between gap-4">
                        <div class="flex-1">
                            <h1 class="text-3xl md:text-4xl font-bold mb-1 flex items-center gap-2 group">
                                {{ activeTag ? '#' + activeTag : 'Dashboard' }}
                                <button v-if="activeTag" @click="openRenameModal" class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-blue-500 transition-opacity p-1"><i class="ph ph-pencil-simple"></i></button>
                                <button v-if="activeTag" @click="setFilter(null)" class="text-xs font-normal text-notion-dim bg-gray-100 px-2 py-1 rounded-full hover:bg-gray-200"><i class="ph ph-x"></i> Clear</button>
                            </h1>
                            <p class="text-notion-dim text-sm">{{ activeTag ? 'Filtered view' : 'Overview' }}</p>
                        </div>
                        <div class="relative w-1/2 md:w-72 self-end"><i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 z-10"></i><input type="text" v-model="searchQuery" placeholder="Search" class="w-full pl-9 pr-10 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 transition-all"><div v-if="searchQuery" class="absolute right-9 top-1 bottom-1 w-8 bg-gradient-to-l from-gray-50 to-transparent pointer-events-none z-10"></div><button v-if="searchQuery" @click="searchQuery=''" class="absolute right-2 top-1/2 -translate-y-1/2 bg-gray-500 hover:bg-gray-600 text-white rounded-full w-5 h-5 flex items-center justify-center transition-colors shadow-sm z-20"><i class="ph-bold ph-x text-[10px]"></i></button></div>
                    </header>

                    <section class="mb-10">
                        <h2 class="text-xs font-bold text-notion-dim uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">Tasks</h2>
                        <div class="relative group mb-4 bg-white border border-gray-200 rounded-lg p-2 focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-400 transition-all shadow-sm" :class="{'border-red-400 ring-2 ring-red-100 shake': taskError}">
                            <div class="flex flex-col md:flex-row gap-2"><div class="flex items-center gap-2 flex-1"><i class="ph ph-plus text-gray-400 ml-1"></i><input type="text" v-model="newTaskInput" @keyup.enter="addTask" placeholder="Add task... (e.g. Buy milk #home)" class="flex-1 px-1 py-1 outline-none text-sm bg-transparent min-w-0"></div><div class="flex items-center gap-2 border-t md:border-t-0 md:border-l border-gray-100 pt-2 md:pt-0 md:pl-2"><input type="datetime-local" v-model="newTaskDue" style="color-scheme: light;" class="flex-1 md:flex-none w-full md:w-auto text-xs text-gray-900 bg-white rounded px-2 outline-none border transition-colors font-mono" :class="taskError ? 'border-red-500' : 'border-gray-300'"><button @click="addTask" class="h-9 px-4 bg-notion-text text-white rounded-md text-xs font-medium hover:opacity-90 whitespace-nowrap">Add</button></div></div>
                            <div v-if="detectedTags.length > 0" class="absolute -bottom-6 left-2 flex gap-1"><span v-for="tag in detectedTags" :key="tag" class="text-[10px] bg-blue-50 text-blue-600 px-1.5 rounded animate-pulse">#{{ tag }} will be added</span></div><div v-if="taskError" class="absolute -bottom-6 right-0 text-[10px] text-red-500 font-bold">* Due date required</div>
                        </div>
                        <div class="space-y-1">
                            <div v-for="task in filteredTasks" :key="task.id" class="p-2 hover:bg-notion-hover rounded group transition-colors duration-200">
                                <div v-if="editingId !== task.id" class="flex items-start gap-3"><button @click="toggleTask(task)" class="mt-0.5 text-gray-400 hover:text-notion-blue transition-colors shrink-0"><i class="ph text-xl" :class="task.completed ? 'ph-check-square text-notion-blue' : 'ph-square'"></i></button><div class="flex-1 min-w-0"><div class="text-sm break-words" :class="{'line-through text-notion-dim': task.completed}"><span v-if="searchQuery" v-html="highlightText(task.title)"></span><span v-else>{{ task.title }}</span></div><div class="flex flex-wrap items-center gap-2 mt-1"><span v-for="tag in task.tags" :key="tag" @click.stop="setFilter(tag)" class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded cursor-pointer hover:bg-gray-200">#{{ tag }}</span><span v-if="task.dueDate" class="text-[10px] flex items-center gap-1 font-mono" :class="getDueDateColor(task)"><i class="ph ph-clock"></i> {{ formatDateTime(task.dueDate) }}</span></div></div><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button @click="startEdit(task)" class="text-gray-400 hover:text-blue-500 p-1"><i class="ph ph-pencil-simple"></i></button><button @click="deleteTask(task.id)" class="text-gray-400 hover:text-red-500 p-1"><i class="ph ph-trash"></i></button></div></div>
                                <div v-else class="flex flex-col gap-2 bg-white border border-blue-200 rounded p-2 shadow-sm">
                                    <input type="text" v-model="editTitle" class="w-full text-sm outline-none border-b border-gray-200 pb-1 font-medium" placeholder="Task title">
                                    <div class="flex items-center gap-2">
                                        <i class="ph ph-tag text-gray-400 text-xs"></i>
                                        <input type="text" v-model="editTagsString" class="flex-1 text-xs text-blue-600 outline-none bg-blue-50/50 rounded px-1" placeholder="#tag1 #tag2">
                                    </div>
                                    <div class="flex items-center justify-between gap-2 mt-1">
                                        <input type="datetime-local" v-model="editDue" style="color-scheme: light;" class="flex-1 text-xs text-gray-900 bg-white rounded px-2 py-1.5 border border-gray-200 h-8 font-mono">
                                        <div class="flex gap-2"><button @click="saveEdit" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 h-8">Save</button><button @click="cancelEdit" class="text-xs text-gray-500 hover:text-gray-700 px-2 py-1 h-8">Cancel</button></div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="filteredTasks.length === 0 && searchQuery" class="text-sm text-gray-400 italic px-2">No tasks matching search.</div>
                        </div>
                    </section>

                    <section>
                        <div class="flex items-center justify-between mb-2"><h2 class="text-xs font-bold text-notion-dim uppercase tracking-wider">Notes</h2><button @click="openEditor(null)" class="flex items-center gap-1.5 text-xs font-medium text-notion-blue hover:bg-blue-50 px-3 py-1.5 rounded transition-colors"><i class="ph ph-plus-circle text-sm"></i> New Note</button></div>
                        <div class="flex gap-2 overflow-x-auto no-scrollbar py-2 mb-4"><button @click="setFilter(null)" class="whitespace-nowrap px-3 py-1 rounded-full text-xs border transition-colors" :class="activeTag === null ? 'bg-gray-800 text-white border-gray-800' : 'bg-white border-gray-200 text-gray-600 hover:border-gray-400'">All</button><button v-for="tag in sortedTags" :key="tag" @click="setFilter(tag)" class="whitespace-nowrap px-3 py-1 rounded-full text-xs border transition-colors" :class="activeTag === tag ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-200 text-gray-600 hover:border-blue-300'">#{{ tag }}</button></div>
                        <div v-if="filteredNotes.length === 0" class="text-center py-10 bg-gray-50 rounded-lg border border-dashed border-gray-200"><p class="text-sm text-gray-400">{{ searchQuery ? 'No notes found.' : 'No notes here.' }}</p></div>
                        <div class="columns-1 md:columns-2 lg:columns-3 xl:columns-4 gap-4 space-y-4">
                            <div v-for="note in filteredNotes" :key="note.id" @click="openEditor(note)" class="break-inside-avoid bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md cursor-pointer transition-all hover:-translate-y-0.5 group flex flex-col relative overflow-hidden"><div class="mb-3 max-h-32 overflow-hidden relative"><div v-if="!note.content" class="text-gray-300 italic text-sm">Empty...</div><div v-else class="preview-text">{{ getPreviewText(note.content) }}</div><div class="absolute bottom-0 left-0 w-full h-6 bg-gradient-to-t from-white to-transparent pointer-events-none"></div></div><div class="flex items-center justify-between pt-2 border-t border-gray-50 mt-auto"><div class="flex gap-1 flex-wrap"><span v-for="tag in note.tags" :key="tag" class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">#{{ tag }}</span></div><span class="text-[10px] text-gray-300 whitespace-nowrap ml-2">{{ formatRelativeTime(note.updatedAt) }}</span></div></div>
                        </div>
                    </section>
                    <div class="h-24"></div>
                </div>
            </div>

            <!-- EDITOR MODAL -->
            <div v-if="editingNote" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm p-4 animate-fade-in" @mousedown.self="startBackdropClick" @click.self="confirmBackdropClick">
                <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden animate-slide-up">
                    <div class="flex items-center gap-1 p-2 border-b border-gray-100 bg-gray-50 text-notion-text shrink-0 overflow-x-auto no-scrollbar">
                        <button @click="closeEditor" class="p-2 hover:bg-gray-200 rounded mr-2 flex-shrink-0"><i class="ph ph-x text-lg"></i></button>
                        <div class="h-6 w-px bg-gray-300 mx-1 flex-shrink-0"></div>
                        <select @change="changeFontSize" class="bg-transparent text-xs border border-gray-200 rounded px-1 py-1 mr-1 focus:outline-none hover:bg-white cursor-pointer"><option value="3">Normal</option><option value="1">Small</option><option value="5">Large</option><option value="7">Huge</option></select>
                        <button @click="copyFormat" class="p-1.5 hover:bg-gray-200 rounded flex-shrink-0 relative" :class="{'text-blue-600 bg-blue-50': copiedStyle}"><i class="ph ph-paint-brush"></i><span v-if="copiedStyle" class="absolute top-0 right-0 w-2 h-2 bg-blue-500 rounded-full border border-white"></span></button>
                        <button @click="pasteFormat" class="p-1.5 rounded flex-shrink-0" :class="copiedStyle ? 'hover:bg-blue-100 text-blue-700' : 'text-gray-300 cursor-not-allowed'" :disabled="!copiedStyle"><i class="ph ph-paint-roller"></i></button>
                        <div class="h-6 w-px bg-gray-300 mx-1 flex-shrink-0"></div>
                        <button @click="execCmd('bold')" class="p-1.5 hover:bg-gray-200 rounded flex-shrink-0"><i class="ph ph-text-b"></i></button>
                        <button @click="execCmd('italic')" class="p-1.5 hover:bg-gray-200 rounded flex-shrink-0"><i class="ph ph-text-italic"></i></button>
                        <button @click="execCmd('underline')" class="p-1.5 hover:bg-gray-200 rounded flex-shrink-0"><i class="ph ph-text-underline"></i></button>
                        <button @click="execCmd('strikeThrough')" class="p-1.5 hover:bg-gray-200 rounded flex-shrink-0"><i class="ph ph-text-strikethrough"></i></button>
                        <div class="h-6 w-px bg-gray-300 mx-1 flex-shrink-0"></div>
                        <button @click="execCmd('formatBlock', 'H1')" class="p-1.5 hover:bg-gray-200 rounded flex-shrink-0"><i class="ph ph-text-h-one"></i></button>
                        <button @click="execCmd('formatBlock', 'H2')" class="p-1.5 hover:bg-gray-200 rounded flex-shrink-0"><i class="ph ph-text-h-two"></i></button>
                        <button @click="execCmd('insertUnorderedList')" class="p-1.5 hover:bg-gray-200 rounded flex-shrink-0"><i class="ph ph-list-bullets"></i></button>
                        <button @click="execCmd('formatBlock', 'blockquote')" class="p-1.5 hover:bg-gray-200 rounded flex-shrink-0"><i class="ph ph-quotes"></i></button>
                        <button @click="insertCheckbox" class="p-1.5 hover:bg-gray-200 rounded flex-shrink-0"><i class="ph ph-check-square"></i></button>
                        <div class="h-6 w-px bg-gray-300 mx-1 flex-shrink-0"></div>
                        <div class="flex gap-1 bg-white border border-gray-200 rounded p-0.5 flex-shrink-0"><button @click="execCmd('hiliteColor', '#FAEB8F')" class="p-1.5 hover:bg-yellow-100 rounded text-yellow-600"><i class="ph ph-highlighter-circle text-lg"></i></button><button @click="execCmd('hiliteColor', 'transparent')" class="p-1.5 hover:bg-gray-100 rounded text-gray-500"><i class="ph ph-eraser text-lg"></i></button></div>
                        <div class="flex-1"></div>
                        <button @click="deleteCurrentNote" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded flex-shrink-0"><i class="ph ph-trash text-lg"></i></button>
                    </div>
                    <div class="px-8 pt-6 pb-2 shrink-0">
                        <div class="flex flex-wrap items-center gap-2 mb-2"><i class="ph ph-tag text-gray-400"></i><div v-for="tag in editingNote.tags" :key="tag" class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-sm flex items-center gap-1">{{ tag }} <button @click="removeTag(tag)" class="hover:text-blue-900"><i class="ph ph-x"></i></button></div><div class="relative"><input ref="tagInputRef" type="text" v-model="tagInput" @keydown.enter.prevent="addTag" @keydown.backspace="onTagBackspace" placeholder="Add tag..." class="outline-none text-sm min-w-[80px] py-1 bg-transparent placeholder-gray-300"><div v-if="tagSuggestions.length > 0" class="absolute top-full left-0 mt-1 w-48 bg-white border border-gray-200 shadow-lg rounded-md z-50 py-1 max-h-40 overflow-y-auto"><div v-for="sug in tagSuggestions" :key="sug" @click="addSuggestedTag(sug)" class="px-3 py-1.5 hover:bg-gray-100 text-sm cursor-pointer text-gray-700">#{{ sug }}</div></div></div></div>
                        <div class="h-px w-full bg-gray-100 mt-2"></div>
                    </div>
                    <div class="flex-1 overflow-y-auto px-8 pb-8 pt-4 cursor-text" @click="$refs.editorRef.focus()">
                        <div ref="editorRef" class="modal-editor outline-none text-notion-text" contenteditable="true" data-placeholder="Start typing your note..." v-safe-html="editingNote.content" @input="onEditorInput" @click="handleEditorClick" @keydown="handleEditorKeydown"></div>
                    </div>
                    <div class="bg-gray-50 px-4 py-2 text-xs text-gray-400 border-t border-gray-100 flex justify-between shrink-0"><span>Words: {{ wordCount }}</span><span>Last edited: {{ formatDateTime(editingNote.updatedAt) }}</span></div>
                </div>
            </div>

            <!-- IMPORT MODAL -->
            <div v-if="showImportModal && pendingImport" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in" @click.self="showImportModal = false">
                <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden animate-slide-up">
                    <div class="bg-gray-50 px-5 py-3 border-b border-gray-100"><h3 class="font-bold text-notion-text flex items-center gap-2"><i class="ph-bold ph-download-simple"></i> Import Data</h3></div>
                    <div class="p-5 space-y-5"><div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg border border-blue-100">Found in backup:<ul class="list-disc pl-5 mt-1 font-medium text-notion-text"><li>{{ (pendingImport.notes || []).length }} Notes</li><li>{{ (pendingImport.tasks || []).length }} Tasks</li></ul></div><div><label class="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-2">Import Items</label><div class="space-y-2"><label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded -mx-2"><input type="checkbox" v-model="importScope.notes" class="rounded text-blue-600 focus:ring-blue-500"><span class="text-sm">Notes</span></label><label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded -mx-2"><input type="checkbox" v-model="importScope.tasks" class="rounded text-blue-600 focus:ring-blue-500"><span class="text-sm">Tasks</span></label></div></div><div><label class="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-2">Method</label><div class="flex gap-2"><label class="flex-1 cursor-pointer"><input type="radio" v-model="importMode" value="merge" class="hidden peer"><div class="border border-gray-200 rounded-lg p-3 text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:bg-gray-50 transition-all"><div class="font-bold text-sm mb-0.5">Merge</div><div class="text-[10px] opacity-70">Add new items</div></div></label><label class="flex-1 cursor-pointer"><input type="radio" v-model="importMode" value="replace" class="hidden peer"><div class="border border-gray-200 rounded-lg p-3 text-center peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:bg-gray-50 transition-all"><div class="font-bold text-sm mb-0.5">Replace</div><div class="text-[10px] opacity-70">Overwrite all</div></div></label></div></div></div>
                    <div class="bg-gray-50 px-5 py-3 border-t border-gray-100 flex justify-end gap-3"><button @click="showImportModal = false" class="text-sm text-gray-500 hover:text-gray-800 font-medium px-2">Cancel</button><button @click="executeImport" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-sm transition-colors">Confirm</button></div>
                </div>
            </div>

            <!-- RENAME TAG MODAL -->
            <div v-if="showRenameModal" 
                 class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in" 
                 @mousedown.self="startBackdropClick" 
                 @click.self="confirmRenameBackdropClick">
                <div class="bg-white w-full max-w-xs rounded-xl shadow-xl overflow-hidden animate-slide-up">
                    <div class="p-4">
                        <h3 class="font-bold text-gray-800 mb-3 text-sm">Rename Tag</h3>
                        <input type="text" v-model="renameInput" @keyup.enter="confirmRename" class="w-full border border-gray-300 rounded px-2 py-2 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-400 outline-none" placeholder="New tag name">
                        <div class="flex justify-end gap-2 mt-4">
                            <button @click="showRenameModal = false" class="text-xs text-gray-500 hover:text-gray-800 font-medium px-2 py-1">Cancel</button>
                            <button @click="confirmRename" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700">Save</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        const app = createApp({
            setup() {
                const sidebarOpen = ref(window.innerWidth > 768);
                const activeTag = ref(null);
                const searchQuery = ref('');
                const tagListRef = ref(null);
                const fileInput = ref(null);
                const storedData = JSON.parse(localStorage.getItem('tagmaster-local') || '{"notes":[], "tasks":[], "tagOrder":[]}');
                const notes = ref(storedData.notes || []);
                const tasks = ref(storedData.tasks || []);
                const tagOrder = ref(storedData.tagOrder || []);
                const newTaskInput = ref('');
                const newTaskDue = ref('');
                const taskError = ref(false);
                
                // Edit Task State
                const editingId = ref(null);
                const editTitle = ref('');
                const editDue = ref('');
                const editTagsString = ref('');

                const editingNote = ref(null);
                const originalNoteId = ref(null);
                const tagInput = ref('');
                const tagInputRef = ref(null);
                const editorRef = ref(null);
                const copiedStyle = ref(null);
                const backdropClickStarted = ref(false);
                const timeTrigger = ref(Date.now());
                const TAG_REGEX = /#[\w\u4e00-\u9fa5]+/g;
                const showImportModal = ref(false);
                const pendingImport = ref(null);
                const importScope = ref({ notes: true, tasks: true });
                const importMode = ref('merge');
                
                // Rename Tag State
                const showRenameModal = ref(false);
                const renameInput = ref('');

                const saveData = () => { localStorage.setItem('tagmaster-local', JSON.stringify({ notes: notes.value, tasks: tasks.value, tagOrder: tagOrder.value })); };
                const exportData = () => { const dataStr = JSON.stringify({ notes: notes.value, tasks: tasks.value, tagOrder: tagOrder.value, exportedAt: new Date().toISOString() }, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `tagmaster-backup-${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
                const importData = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const json = JSON.parse(e.target.result); if (Array.isArray(json.notes) || Array.isArray(json.tasks)) { pendingImport.value = json; showImportModal.value = true; } else { alert('Invalid backup file format.'); } } catch (err) { alert('Error parsing file.'); } event.target.value = ''; }; reader.readAsText(file); };
                const executeImport = () => { if (!pendingImport.value) return; const source = pendingImport.value; if (importScope.value.notes) { if (importMode.value === 'replace') { notes.value = source.notes || []; } else { const existingIds = new Set(notes.value.map(n => n.id)); const newNotes = (source.notes || []).filter(n => !existingIds.has(n.id)); notes.value = [...notes.value, ...newNotes]; } } if (importScope.value.tasks) { if (importMode.value === 'replace') { tasks.value = source.tasks || []; } else { const existingIds = new Set(tasks.value.map(t => t.id)); const newTasks = (source.tasks || []).filter(t => !existingIds.has(t.id)); tasks.value = [...tasks.value, ...newTasks]; } } const isFullReplace = importMode.value === 'replace' && importScope.value.notes && importScope.value.tasks; if (isFullReplace) { tagOrder.value = source.tagOrder || []; } else { const newTags = source.tagOrder || []; const currentTags = new Set(tagOrder.value); newTags.forEach(t => { if (!currentTags.has(t)) tagOrder.value.push(t); }); } saveData(); showImportModal.value = false; pendingImport.value = null; alert('Import successful!'); };
                
                // 1. UPDATED setFilter: Pre-fill input
                const setFilter = (tag) => { 
                    activeTag.value = tag; 
                    if (tag && newTaskInput.value.trim() === '') {
                        newTaskInput.value = `#${tag} `;
                    }
                    if(window.innerWidth < 768) sidebarOpen.value = false; 
                };
                
                const highlightText = (text) => { if (!searchQuery.value) return text; const regex = new RegExp(`(${searchQuery.value})`, 'gi'); return text.replace(regex, '<span class="bg-yellow-200 text-black rounded px-0.5">$1</span>'); };
                const getPreviewText = (html) => { if (!html) return ''; const tempDiv = document.createElement("div"); tempDiv.innerHTML = html; return tempDiv.textContent || tempDiv.innerText || ""; };
                const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
                const parseTags = (text) => { const m = text.match(TAG_REGEX); return m ? m.map(t => t.slice(1)) : []; };
                const formatDateTime = (d) => { if(!d) return ''; const date = new Date(d); return `${date.getMonth()+1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`; };
                const formatRelativeTime = (d) => { const diff = Date.now() - new Date(d).getTime(); if(diff < 60000) return 'Just now'; if(diff < 86400000) return Math.floor(diff/3600000) + 'h ago'; return formatDateTime(d); };
                const getDueDateColor = (task) => { if (task.completed) return 'text-gray-400'; return new Date(task.dueDate).getTime() < timeTrigger.value ? 'text-notion-red font-bold' : 'text-gray-400'; };
                const detectedTags = computed(() => parseTags(newTaskInput.value));
                
                // 2. UPDATED addTask: Reset logic
                const addTask = () => { 
                    if (!newTaskInput.value.trim()) return; 
                    if (!newTaskDue.value) { taskError.value = true; setTimeout(() => taskError.value = false, 2000); return; } 
                    
                    const cleanTitle = newTaskInput.value.replace(TAG_REGEX, '').replace(/\s+/g, ' ').trim(); 
                    const tags = parseTags(newTaskInput.value);
                    
                    tasks.value.push({ id: generateId(), title: cleanTitle || "Untitled", completed: false, dueDate: newTaskDue.value, tags: tags }); 
                    
                    // Reset input, but keep tag if filter is active
                    if (activeTag.value) {
                        newTaskInput.value = `#${activeTag.value} `;
                    } else {
                        newTaskInput.value = '';
                    }
                    
                    newTaskDue.value = ''; 
                    taskError.value = false; 
                    saveData(); 
                };
                
                // Enhanced Task Edit
                const startEdit = (t) => { 
                    editingId.value = t.id; 
                    editTitle.value = t.title; 
                    editDue.value = t.dueDate;
                    // Pre-fill tags string for editing
                    editTagsString.value = t.tags.map(tag => '#' + tag).join(' ');
                };
                
                const saveEdit = () => { 
                    const t = tasks.value.find(x => x.id === editingId.value); 
                    if(t && editTitle.value.trim() && editDue.value){ 
                        t.title = editTitle.value; 
                        t.dueDate = editDue.value;
                        // Parse new tags
                        const newTags = parseTags(editTagsString.value);
                        t.tags = newTags.length > 0 ? newTags : []; // Update tags
                        saveData(); 
                    } 
                    editingId.value = null; 
                };
                const cancelEdit = () => { editingId.value = null; };
                const toggleTask = (t) => { t.completed = !t.completed; saveData(); };
                const deleteTask = (id) => { tasks.value = tasks.value.filter(t => t.id !== id); saveData(); };
                
                // === TAG SYSTEM ENHANCEMENTS ===
                const sortedTags = computed(() => {
                    const rawTags = [];
                    // Collect all tags but preserve their original casing first
                    // We need a canonical map: lowercase key -> display value
                    const canonicalMap = new Map();
                    
                    // Priority 1: Existing Tag Order (User preference)
                    tagOrder.value.forEach(t => {
                        if (!canonicalMap.has(t.toLowerCase())) canonicalMap.set(t.toLowerCase(), t);
                    });
                    
                    // Priority 2: Notes & Tasks (Discovery)
                    const scan = (list) => {
                        list.forEach(item => {
                            item.tags.forEach(t => {
                                if (!canonicalMap.has(t.toLowerCase())) canonicalMap.set(t.toLowerCase(), t);
                            });
                        });
                    };
                    scan(notes.value);
                    scan(tasks.value);
                    
                    // Build result list
                    const result = Array.from(canonicalMap.values());
                    
                    // Sort based on tagOrder, then alphabetical
                    const orderMap = new Map();
                    tagOrder.value.forEach((t, i) => orderMap.set(t.toLowerCase(), i));
                    
                    return result.sort((a, b) => {
                        const iA = orderMap.has(a.toLowerCase()) ? orderMap.get(a.toLowerCase()) : 9999;
                        const iB = orderMap.has(b.toLowerCase()) ? orderMap.get(b.toLowerCase()) : 9999;
                        return iA !== iB ? iA - iB : a.localeCompare(b);
                    });
                });

                // Filter Logic: Case Insensitive
                const filteredTasks = computed(() => { 
                    let res = tasks.value; 
                    if (activeTag.value) {
                        const filterLower = activeTag.value.toLowerCase();
                        res = res.filter(task => task.tags.some(t => t.toLowerCase() === filterLower)); 
                    }
                    if (searchQuery.value) res = res.filter(task => task.title.toLowerCase().includes(searchQuery.value.toLowerCase())); 
                    return res.sort((a, b) => { if (a.completed !== b.completed) return a.completed ? 1 : -1; const dateA = new Date(a.dueDate).getTime(); const dateB = new Date(b.dueDate).getTime(); return dateA - dateB; }); 
                });
                
                const filteredNotes = computed(() => { 
                    let res = notes.value; 
                    if (activeTag.value) {
                        const filterLower = activeTag.value.toLowerCase();
                        res = res.filter(n => n.tags.some(t => t.toLowerCase() === filterLower)); 
                    }
                    if (searchQuery.value) { const q = searchQuery.value.toLowerCase(); res = res.filter(n => getPreviewText(n.content).toLowerCase().includes(q) || n.tags.some(t => t.toLowerCase().includes(q))); } return res; 
                });

                // Rename Tag Logic
                const openRenameModal = () => {
                    renameInput.value = activeTag.value;
                    showRenameModal.value = true;
                };

                const confirmRename = () => {
                    if (!renameInput.value.trim() || renameInput.value === activeTag.value) {
                        showRenameModal.value = false;
                        return;
                    }
                    const oldLower = activeTag.value.toLowerCase();
                    const newTag = renameInput.value.trim();
                    
                    // Update Notes
                    notes.value.forEach(note => {
                        if (note.tags.some(t => t.toLowerCase() === oldLower)) {
                            note.tags = note.tags.map(t => t.toLowerCase() === oldLower ? newTag : t);
                            // Dedupe
                            note.tags = [...new Set(note.tags)];
                        }
                    });
                    
                    // Update Tasks
                    tasks.value.forEach(task => {
                        if (task.tags.some(t => t.toLowerCase() === oldLower)) {
                            task.tags = task.tags.map(t => t.toLowerCase() === oldLower ? newTag : t);
                            task.tags = [...new Set(task.tags)];
                        }
                    });
                    
                    // Update Tag Order List
                    const orderIdx = tagOrder.value.findIndex(t => t.toLowerCase() === oldLower);
                    if (orderIdx !== -1) {
                        tagOrder.value[orderIdx] = newTag;
                    }
                    
                    activeTag.value = newTag;
                    saveData();
                    showRenameModal.value = false;
                };

                // 3. UPDATED openEditor: Pre-fill tag in new note
                const openEditor = (n) => { 
                    if (n) { 
                        originalNoteId.value = n.id; 
                        editingNote.value = JSON.parse(JSON.stringify(n)); 
                    } else { 
                        originalNoteId.value = null; 
                        // Auto-add active tag
                        const initialTags = activeTag.value ? [activeTag.value] : [];
                        editingNote.value = { 
                            id: generateId(), 
                            content: '', 
                            tags: initialTags, 
                            updatedAt: Date.now() 
                        }; 
                    } 
                    tagInput.value = ''; 
                };
                
                // BACKDROP CLICK FIX
                const startBackdropClick = () => { backdropClickStarted.value = true; };
                const confirmBackdropClick = () => { if (backdropClickStarted.value) closeEditor(); backdropClickStarted.value = false; };
                
                // FIX: Rename Modal Backdrop Click Logic
                const confirmRenameBackdropClick = () => {
                    if (backdropClickStarted.value) {
                        showRenameModal.value = false;
                    }
                    backdropClickStarted.value = false;
                };

                const closeEditor = () => { if (!editingNote.value) return; if (originalNoteId.value) { const idx = notes.value.findIndex(n => n.id === originalNoteId.value); if (idx !== -1) notes.value[idx] = editingNote.value; } else { if (editingNote.value.content.trim() || editingNote.value.tags.length > 0) notes.value.unshift(editingNote.value); } saveData(); editingNote.value = null; };
                const onEditorInput = (e) => { editingNote.value.content = e.target.innerHTML; editingNote.value.updatedAt = Date.now(); saveData(); };
                const deleteCurrentNote = () => { if (confirm('Delete?')) { if (originalNoteId.value) notes.value = notes.value.filter(n => n.id !== originalNoteId.value); saveData(); editingNote.value = null; }};
                const execCmd = (c, v = null) => { document.execCommand(c, false, v); };
                const changeFontSize = (e) => { execCmd('fontSize', e.target.value); };
                
                const insertCheckbox = () => {
                    const sel = window.getSelection();
                    if (!sel.rangeCount) return;
                    const range = sel.getRangeAt(0);
                    if (sel.isCollapsed) { document.execCommand('insertHTML', false, '<input type="checkbox">&nbsp;'); } 
                    else {
                        const frag = range.extractContents();
                        const tempDiv = document.createElement('div');
                        tempDiv.appendChild(frag);
                        let html = tempDiv.innerHTML;
                        if (html.includes('<div') || html.includes('<p')) { html = html.replace(/<(div|p)([^>]*)>/gi, '<$1$2><input type="checkbox">&nbsp;'); } 
                        else { html = `<div><input type="checkbox">&nbsp;${html}</div>`; }
                        document.execCommand('insertHTML', false, html);
                    }
                    onEditorInput({ target: editorRef.value });
                };

                const handleEditorClick = (e) => { if (e.target.tagName === 'INPUT' && e.target.type === 'checkbox') { if (e.target.hasAttribute('checked')) { e.target.removeAttribute('checked'); } else { e.target.setAttribute('checked', 'checked'); } onEditorInput({ target: editorRef.value }); } };
                
                const handleEditorKeydown = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        const sel = window.getSelection();
                        if (!sel.rangeCount) return;
                        let currentNode = sel.anchorNode;
                        if (currentNode.nodeType === 3) currentNode = currentNode.parentNode;
                        let block = currentNode;
                        while (block && block.parentNode !== editorRef.value && block !== editorRef.value) { block = block.parentNode; }
                        if (!block || block === editorRef.value) return; 
                        const checkbox = block.querySelector('input[type="checkbox"]');
                        if (!checkbox) return;
                        const clone = block.cloneNode(true);
                        const cloneCb = clone.querySelector('input[type="checkbox"]');
                        if (cloneCb) cloneCb.remove();
                        const text = clone.textContent.replace(/[\s\u00A0]/g, ''); 
                        if (text === '') { e.preventDefault(); checkbox.remove(); onEditorInput({ target: editorRef.value }); } 
                        else { setTimeout(() => { document.execCommand('insertHTML', false, '<input type="checkbox">&nbsp;'); onEditorInput({ target: editorRef.value }); }, 0); }
                    }
                };

                const copyFormat = () => { copiedStyle.value = { bold: document.queryCommandState('bold'), italic: document.queryCommandState('italic'), underline: document.queryCommandState('underline'), strikethrough: document.queryCommandState('strikethrough'), foreColor: document.queryCommandValue('foreColor'), hiliteColor: document.queryCommandValue('hiliteColor'), fontSize: document.queryCommandValue('fontSize') }; };
                const pasteFormat = () => { if(!copiedStyle.value) return; const s = copiedStyle.value; if(document.queryCommandState('bold') !== s.bold) execCmd('bold'); if(document.queryCommandState('italic') !== s.italic) execCmd('italic'); if(document.queryCommandState('underline') !== s.underline) execCmd('underline'); if(document.queryCommandState('strikethrough') !== s.strikethrough) execCmd('strikeThrough'); execCmd('foreColor', s.foreColor); execCmd('hiliteColor', s.hiliteColor); execCmd('fontSize', s.fontSize); };
                const tagSuggestions = computed(() => { if (!tagInput.value) return []; return sortedTags.value.filter(t => t.toLowerCase().includes(tagInput.value.toLowerCase()) && !editingNote.value.tags.includes(t)); });
                const addTag = () => { const v = tagInput.value.trim().replace(/^#/, ''); if (v && !editingNote.value.tags.includes(v)) editingNote.value.tags.push(v); tagInput.value = ''; };
                const addSuggestedTag = (t) => { if (!editingNote.value.tags.includes(t)) editingNote.value.tags.push(t); tagInput.value = ''; };
                const removeTag = (t) => { editingNote.value.tags = editingNote.value.tags.filter(x => x !== t); };
                const onTagBackspace = () => { if (tagInput.value === '' && editingNote.value.tags.length > 0) editingNote.value.tags.pop(); };
                const wordCount = computed(() => { if (!editingNote.value) return 0; return editingNote.value.content.replace(/<[^>]*>/g, ' ').trim().split(/\s+/).filter(w => w.length > 0).length; });

                onMounted(() => {
                    if (tagListRef.value) { new Sortable(tagListRef.value, { animation: 150, ghostClass: 'opacity-40', onEnd: (evt) => { const items = evt.to.children; const newOrder = []; for(let i=0; i<items.length; i++) newOrder.push(items[i].getAttribute('data-id')); tagOrder.value = newOrder; saveData(); }}); }
                    setInterval(() => timeTrigger.value = Date.now(), 60000);
                    document.execCommand('defaultParagraphSeparator', false, 'div');
                });

                return {
                    sidebarOpen, activeTag, searchQuery, tagListRef, sortedTags, setFilter, highlightText,
                    newTaskInput, newTaskDue, taskError, detectedTags, addTask, toggleTask, deleteTask, getDueDateColor,
                    editingId, editTitle, editDue, editTagsString, startEdit, saveEdit, cancelEdit, // Edit State
                    filteredTasks, filteredNotes, formatDateTime, formatRelativeTime, getPreviewText,
                    editingNote, openEditor, closeEditor, onEditorInput, deleteCurrentNote, editorRef, 
                    execCmd, changeFontSize, insertCheckbox, handleEditorClick, handleEditorKeydown, wordCount,
                    copyFormat, pasteFormat, copiedStyle, startBackdropClick, confirmBackdropClick,
                    tagInput, tagSuggestions, addTag, addSuggestedTag, removeTag, onTagBackspace, tagInputRef,
                    exportData, importData, fileInput, showImportModal, pendingImport, importScope, importMode, executeImport,
                    openRenameModal, showRenameModal, renameInput, confirmRename, confirmRenameBackdropClick // Rename & Fix
                };
            }
        });

        app.directive('safe-html', {
            mounted(el, binding) { el.innerHTML = binding.value; },
            updated(el, binding) { if (el.innerHTML !== binding.value && document.activeElement !== el) el.innerHTML = binding.value; }
        });

        app.mount('#app');
    </script>
</body>
</html>